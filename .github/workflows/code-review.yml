name: Code Review

on:
  pull_request:
    branches: ["main", "master"]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-review:
    name: Lint & Format Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install lint tools
        run: pip install flake8 black

      - name: Run flake8
        id: flake8
        continue-on-error: true
        run: |
          flake8 src/ tests/ --max-line-length=120 --statistics 2>&1 | tee flake8_output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Run black check
        id: black
        continue-on-error: true
        run: |
          black --check --line-length=120 src/ tests/ 2>&1 | tee black_output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Build review comment
        id: build-comment
        run: |
          FLAKE8_OUT=$(cat flake8_output.txt)
          BLACK_OUT=$(cat black_output.txt)
          FLAKE8_STATUS=${{ steps.flake8.outputs.exit_code }}
          BLACK_STATUS=${{ steps.black.outputs.exit_code }}

          if [ "$FLAKE8_STATUS" = "0" ]; then
            FLAKE8_ICON="‚úÖ"
          else
            FLAKE8_ICON="‚ùå"
          fi

          if [ "$BLACK_STATUS" = "0" ]; then
            BLACK_ICON="‚úÖ"
          else
            BLACK_ICON="‚ùå"
          fi

          {
            echo 'COMMENT<<EOF'
            echo "## ü§ñ Automated Code Review"
            echo ""
            echo "| Check | Status |"
            echo "|---|---|"
            echo "| flake8 (style) | $FLAKE8_ICON |"
            echo "| black (format) | $BLACK_ICON |"
            echo ""
            echo "### flake8 Output"
            echo '```'
            echo "${FLAKE8_OUT:-No issues found.}"
            echo '```'
            echo ""
            echo "### black Output"
            echo '```'
            echo "${BLACK_OUT:-All files are well-formatted.}"
            echo '```'
            echo ""
            echo "_Auto-generated by [Code Review workflow](../actions). Run \`black src/ tests/\` to auto-fix formatting._"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.build-comment.outputs.COMMENT }}
          edit-mode: replace
          comment-author: "github-actions[bot]"
          body-includes: "ü§ñ Automated Code Review"
